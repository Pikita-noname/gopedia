---
title: "5.6 üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (sync –ø–∞–∫–µ—Ç)"
description: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ Go: sync –ø–∞–∫–µ—Ç, Mutex, RWMutex, WaitGroup, Once. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ä–∞–∑–¥–µ–ª—è–µ–º—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."
keywords: ["sync golang", "mutex go", "—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è golang", "waitgroup go"]
date: 2025-08-14
weight: 56
draft: false
---

**–ü–∞–∫–µ—Ç sync** —è–≤–ª—è–µ—Ç—Å—è –∫—Ä–∞–µ—É–≥–æ–ª—å–Ω—ã–º –∫–∞–º–Ω–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Go. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–µ–º –ø—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–¥–µ–ª—è–µ–º—ã–º —Ä–µ—Å—É—Ä—Å–∞–º –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö. –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ Go –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é "–Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª—è–µ–º—É—é –ø–∞–º—è—Ç—å, –∞ —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö", –ø–∞–∫–µ—Ç sync –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–º –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∑–∞–¥–∞—á.

–í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø–æ–Ω–∏–º–∞–Ω–∏–µ sync –ø–∞–∫–µ—Ç–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å thread-safe —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, —É–ø—Ä–∞–≤–ª—è—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É —Å–ª–æ–∂–Ω—ã—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤.

## üéØ –§–∏–ª–æ—Å–æ—Ñ–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ Go

### –ö–∞–Ω–∞–ª—ã vs sync: –∫–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

Go –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥–≤–∞ –ø–æ–¥—Ö–æ–¥–∞ –∫ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é:
1. **–ö–∞–Ω–∞–ª—ã** - –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –º–µ–∂–¥—É –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏
2. **sync –ø–∞–∫–µ—Ç** - –¥–ª—è –∑–∞—â–∏—Ç—ã —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–Ω–∞–ª—ã, –∫–æ–≥–¥–∞:**
- –ü–µ—Ä–µ–¥–∞–µ—Ç–µ –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏
- –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- –†–µ–∞–ª–∏–∑—É–µ—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã producer-consumer
- –°—Ç—Ä–æ–∏—Ç–µ –∫–æ–Ω–≤–µ–π–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ sync, –∫–æ–≥–¥–∞:**
- –ó–∞—â–∏—â–∞–µ—Ç–µ —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å—á–µ—Ç—á–∏–∫–∏, –∫—ç—à–∏, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
- –ù—É–∂–Ω–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- –û–∂–∏–¥–∞–µ—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –≥–æ—Ä—É—Ç–∏–Ω
- –†–µ–∞–ª–∏–∑—É–µ—Ç–µ thread-safe —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ memory model

Sync –ø—Ä–∏–º–∏—Ç–∏–≤—ã –≤ Go –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ memory barriers, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –í—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞ —Å—á–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ overhead
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –º–Ω–æ–≥–æ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
- –ì–∞—Ä–∞–Ω—Ç–∏–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞

> üí¨ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**  
> –í –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ sync.RWMutex –º–æ–∂–µ—Ç –¥–∞—Ç—å –ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–æ 300% –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –æ–±—ã—á–Ω—ã–º Mutex, –∫–æ–≥–¥–∞ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è –∫ –∑–∞–ø–∏—Å–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 10:1.

---

## üîí Mutex - –æ—Å–Ω–æ–≤–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

Mutex (mutual exclusion) ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–º–∏—Ç–∏–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º. –í –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ concurrent –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ race conditions ‚Äî —Å–∏—Ç—É–∞—Ü–∏—è–º, –∫–æ–≥–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ timing –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω.

### –ê–Ω–∞—Ç–æ–º–∏—è race condition

Race condition –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä—É—Ç–∏–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–∏—Ç–∞—é—Ç –∏ –∏–∑–º–µ–Ω—è—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ. –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä ‚Äî –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞:
1. –ì–æ—Ä—É—Ç–∏–Ω–∞ A —á–∏—Ç–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5)
2. –ì–æ—Ä—É—Ç–∏–Ω–∞ B —á–∏—Ç–∞–µ—Ç —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ (5)
3. –û–±–µ –≥–æ—Ä—É—Ç–∏–Ω—ã —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –Ω–∞ 1
4. –ì–æ—Ä—É—Ç–∏–Ω–∞ A –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç 6
5. –ì–æ—Ä—É—Ç–∏–Ω–∞ B –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç 6
–†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ 7 –ø–æ–ª—É—á–∞–µ–º 6

### Mutex –∫–∞–∫ —Ä–µ—à–µ–Ω–∏–µ

Mutex —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É, —Å–æ–∑–¥–∞–≤–∞—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é ‚Äî —É—á–∞—Å—Ç–æ–∫ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏. Go –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Å—Ç–æ–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º—å—é—Ç–µ–∫—Å–∞–º–∏.

### –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

```go
// –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ - race condition –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
type UnsafeCounter struct {
    value int
}

func (c *UnsafeCounter) Increment() {
    c.value++ // –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è!
}

// –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —Å Mutex
type SafeCounter struct {
    mu    sync.Mutex
    value int
}

func (c *SafeCounter) Increment() {
    c.mu.Lock()         // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
    defer c.mu.Unlock() // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
    c.value++           // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
}

func (c *SafeCounter) Value() int {
    c.mu.Lock()
    defer c.mu.Unlock()
    return c.value // –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
}
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ 1000 –≥–æ—Ä—É—Ç–∏–Ω, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—á–µ—Ç—á–∏–∫ 1000 —Ä–∞–∑:

**UnsafeCounter:**
- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 1,000,000
- –†–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ~850,000-950,000 (—Å–ª—É—á–∞–π–Ω—ã–π)
- –í—Ä–µ–º—è: ~50ms
- –°—Ç–∞—Ç—É—Å: ‚ùå Race condition!

**SafeCounter (Mutex):**
- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 1,000,000
- –†–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 1,000,000 (–≤—Å–µ–≥–¥–∞)
- –í—Ä–µ–º—è: ~200ms
- –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ

#### –¶–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

Mutex –¥–æ–±–∞–≤–ª—è–µ—Ç overhead:
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞**: ~10-20ns –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
- **Contention**: –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤—Ä–µ–º—è —Ä–∞—Å—Ç–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ
- **Context switching**: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏

–ù–æ —ç—Ç–æ —Ü–µ–Ω–∞ –∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

---

## üìñ RWMutex - —á–∏—Ç–∞—Ç–µ–ª–∏-–ø–∏—Å–∞—Ç–µ–ª–∏

RWMutex (Read-Write Mutex) —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∫–æ–≥–¥–∞ —É –≤–∞—Å –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è –∏ –º–∞–ª–æ –∑–∞–ø–∏—Å–∏.

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã RWMutex

```go
type DataStore struct {
    mu   sync.RWMutex
    data map[string]string
}

// –ß—Ç–µ–Ω–∏–µ - –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
func (ds *DataStore) Get(key string) (string, bool) {
    ds.mu.RLock()         // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
    defer ds.mu.RUnlock()
    
    value, exists := ds.data[key]
    return value, exists
}

// –ó–∞–ø–∏—Å—å - —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
func (ds *DataStore) Set(key, value string) {
    ds.mu.Lock()         // –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    defer ds.mu.Unlock()
    
    ds.data[key] = value
}
```

#### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RWMutex

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ RWMutex –∫–æ–≥–¥–∞:**
- –û–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–µ, —á–µ–º –∑–∞–ø–∏—Å–∏ (—Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ 5:1 –∏ –±–æ–ª—å—à–µ)
- –û–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è –∑–∞–Ω–∏–º–∞—é—Ç –∑–∞–º–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è
- –£ –≤–∞—Å –º–Ω–æ–≥–æ concurrent readers

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–π Mutex –∫–æ–≥–¥–∞:**
- –û–ø–µ—Ä–∞—Ü–∏–∏ –±—ã—Å—Ç—Ä—ã–µ (<1Œºs)
- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è –∫ –∑–∞–ø–∏—Å–∏ –±–ª–∏–∑–∫–æ –∫ 1:1
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å RWMutex

**Benchmark —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (1000 –≥–æ—Ä—É—Ç–∏–Ω):**

–ü—Ä–∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–∏ read:write = 10:1:
- **Mutex**: 500ms
- **RWMutex**: 150ms (–ø—Ä–∏—Ä–æ—Å—Ç 300%)

–ü—Ä–∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–∏ read:write = 1:1:
- **Mutex**: 200ms
- **RWMutex**: 250ms (overhead 25%)

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

RWMutex –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- **–°–µ–º–∞—Ñ–æ—Ä –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª–µ–π**: —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö readers
- **–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π lock –¥–ª—è –ø–∏—Å–∞—Ç–µ–ª–µ–π**: –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **Writer starvation prevention**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≥–æ–ª–æ–¥–∞–Ω–∏–µ –ø–∏—Å–∞—Ç–µ–ª–µ–π

---

## üë• WaitGroup - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≥–æ—Ä—É—Ç–∏–Ω

WaitGroup —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á—É –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –≥–æ—Ä—É—Ç–∏–Ω. –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è graceful shutdown –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã WaitGroup

```go
var wg sync.WaitGroup

// –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≥–æ—Ä—É—Ç–∏–Ω
wg.Add(3) // –û–∂–∏–¥–∞–µ–º 3 –≥–æ—Ä—É—Ç–∏–Ω—ã

// –í –∫–∞–∂–¥–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
go func() {
    defer wg.Done() // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞ 1
    // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–±–æ—Ç—É...
}()

// –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω
wg.Wait() // –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ–∫–∞ —Å—á–µ—Ç—á–∏–∫ –Ω–µ —Å—Ç–∞–Ω–µ—Ç 0
```

#### –ü–∞—Ç—Ç–µ—Ä–Ω Worker Pool

```go
func workerPool() {
    const numWorkers = 5
    tasks := make(chan Task, 100)
    var wg sync.WaitGroup
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º workers
    for i := 0; i < numWorkers; i++ {
        wg.Add(1)
        go func(workerID int) {
            defer wg.Done()
            
            for task := range tasks {
                processTask(task)
            }
        }(i)
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏
    for _, task := range getAllTasks() {
        tasks <- task
    }
    close(tasks) // –í–∞–∂–Ω–æ: –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª
    
    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö workers
    wg.Wait()
}
```

#### –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

**1. –í—ã–∑–æ–≤ Add() –≤ –≥–æ—Ä—É—Ç–∏–Ω–µ:**
```go
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - race condition
go func() {
    wg.Add(1) // –ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –ø–æ—Å–ª–µ wg.Wait()
    defer wg.Done()
    // —Ä–∞–±–æ—Ç–∞...
}()

// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
wg.Add(1)
go func() {
    defer wg.Done()
    // —Ä–∞–±–æ—Ç–∞...
}()
```

**2. –ó–∞–±—ã–ª–∏ Done():**
```go
// ‚ùå Deadlock - wg.Wait() –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –≤–µ—á–Ω–æ
wg.Add(1)
go func() {
    // –ó–∞–±—ã–ª–∏ wg.Done()!
    doWork()
}()
wg.Wait()
```

**3. –ü–µ—Ä–µ–¥–∞—á–∞ WaitGroup –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é:**
```go
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
func badWorker(wg sync.WaitGroup) {
    defer wg.Done() // –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π WaitGroup!
}

// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
func goodWorker(wg *sync.WaitGroup) {
    defer wg.Done()
}
```

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

**Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ multiple sources
- –í–∞–ª–∏–¥–∞—Ü–∏—è –±–æ–ª—å—à–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö

**Graceful shutdown:**
- –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö HTTP requests
- –ó–∞–∫—Ä—ã—Ç–∏–µ database connections
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ state –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º

---

## üîÑ Once - –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```go
package main

import (
    "fmt"
    "sync"
    "time"
)

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
var (
    config     *AppConfig
    configOnce sync.Once
)

type AppConfig struct {
    DatabaseURL string
    APIKey      string
    Debug       bool
    LoadedAt    time.Time
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–≤—ã–∑–æ–≤–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
func initConfig() {
    fmt.Println("üîß –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...")
    
    // –°–∏–º—É–ª–∏—Ä—É–µ–º –¥–æ–ª–≥—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    time.Sleep(2 * time.Second)
    
    config = &AppConfig{
        DatabaseURL: "postgresql://localhost:5432/mydb",
        APIKey:      "secret-api-key",
        Debug:       true,
        LoadedAt:    time.Now(),
    }
    
    fmt.Println("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")
}

// GetConfig –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
func GetConfig() *AppConfig {
    configOnce.Do(initConfig) // initConfig –≤—ã–∑–æ–≤–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
    return config
}

// –°–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
func databaseService(id int, wg *sync.WaitGroup) {
    defer wg.Done()
    
    fmt.Printf("üóÑÔ∏è  Database Service %d: –ø–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...\n", id)
    
    cfg := GetConfig()
    
    fmt.Printf("üóÑÔ∏è  Database Service %d: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ %s\n", id, cfg.DatabaseURL)
    fmt.Printf("üóÑÔ∏è  Database Service %d: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ %s\n", id, cfg.LoadedAt.Format("15:04:05"))
}

func apiService(id int, wg *sync.WaitGroup) {
    defer wg.Done()
    
    fmt.Printf("üåê API Service %d: –ø–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...\n", id)
    
    cfg := GetConfig()
    
    fmt.Printf("üåê API Service %d: –∏—Å–ø–æ–ª—å–∑—É–µ–º API –∫–ª—é—á %s\n", id, cfg.APIKey)
    fmt.Printf("üåê API Service %d: —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: %t\n", id, cfg.Debug)
}

// Singleton –ø–∞—Ç—Ç–µ—Ä–Ω —Å Once
type Logger struct {
    level string
    file  string
}

var (
    logger     *Logger
    loggerOnce sync.Once
)

func GetLogger() *Logger {
    loggerOnce.Do(func() {
        fmt.Println("üìù –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–≥–µ—Ä...")
        time.Sleep(1 * time.Second) // –°–∏–º—É–ª–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        
        logger = &Logger{
            level: "INFO",
            file:  "/var/log/app.log",
        }
        fmt.Println("üìù –õ–æ–≥–≥–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
    })
    return logger
}

func (l *Logger) Log(message string) {
    fmt.Printf("[%s] %s\n", l.level, message)
}

func serviceWithLogging(name string, wg *sync.WaitGroup) {
    defer wg.Done()
    
    log := GetLogger()
    log.Log(fmt.Sprintf("–°–µ—Ä–≤–∏—Å %s –∑–∞–ø—É—â–µ–Ω", name))
    
    time.Sleep(500 * time.Millisecond)
    
    log.Log(fmt.Sprintf("–°–µ—Ä–≤–∏—Å %s –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞–±–æ—Ç—É", name))
    
    time.Sleep(500 * time.Millisecond)
    
    log.Log(fmt.Sprintf("–°–µ—Ä–≤–∏—Å %s –∑–∞–≤–µ—Ä—à–µ–Ω", name))
}

func main() {
    fmt.Println("üîÑ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è sync.Once")
    fmt.Println()
    
    // –¢–µ—Å—Ç 1: –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    fmt.Println("=== –¢–µ—Å—Ç 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ===")
    
    var wg1 sync.WaitGroup
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    for i := 1; i <= 3; i++ {
        wg1.Add(1)
        go databaseService(i, &wg1)
    }
    
    for i := 1; i <= 2; i++ {
        wg1.Add(1)
        go apiService(i, &wg1)
    }
    
    wg1.Wait()
    fmt.Println()
    
    // –¢–µ—Å—Ç 2: Singleton –ø–∞—Ç—Ç–µ—Ä–Ω —Å –ª–æ–≥–≥–µ—Ä–æ–º
    fmt.Println("=== –¢–µ—Å—Ç 2: Singleton –ª–æ–≥–≥–µ—Ä ===")
    
    var wg2 sync.WaitGroup
    services := []string{"UserService", "OrderService", "PaymentService"}
    
    for _, serviceName := range services {
        wg2.Add(1)
        go serviceWithLogging(serviceName, &wg2)
    }
    
    wg2.Wait()
    
    fmt.Println("\n‚ú® –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!")
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç—ã —Å–æ–∑–¥–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
    fmt.Println("\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:")
    fmt.Printf("Config pointer: %p\n", config)
    fmt.Printf("Logger pointer: %p\n", logger)
    
    // –ï—â–µ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ - –æ–±—ä–µ–∫—Ç—ã –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç—Å—è
    cfg2 := GetConfig()
    log2 := GetLogger()
    fmt.Printf("Config pointer (2nd call): %p\n", cfg2)
    fmt.Printf("Logger pointer (2nd call): %p\n", log2)
    
    if config == cfg2 && logger == log2 {
        fmt.Println("‚úÖ –û–±—ä–µ–∫—Ç—ã –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å - sync.Once —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
    }
}
```

---

## üéØ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: Thread-safe –∫—ç—à

```go
package main

import (
    "fmt"
    "math/rand"
    "sync"
    "time"
)

// –≠–ª–µ–º–µ–Ω—Ç –∫—ç—à–∞
type CacheItem struct {
    Value     interface{}
    ExpiresAt time.Time
}

func (ci *CacheItem) IsExpired() bool {
    return time.Now().After(ci.ExpiresAt)
}

// Thread-safe –∫—ç—à —Å TTL
type Cache struct {
    mu    sync.RWMutex
    items map[string]*CacheItem
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    hits   int64
    misses int64
    
    // –î–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏
    stopCleanup chan bool
    cleanupOnce sync.Once
}

func NewCache() *Cache {
    cache := &Cache{
        items:       make(map[string]*CacheItem),
        stopCleanup: make(chan bool),
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É
    cache.startCleanup()
    
    return cache
}

// –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
func (c *Cache) startCleanup() {
    c.cleanupOnce.Do(func() {
        go c.cleanupLoop()
    })
}

// –¶–∏–∫–ª –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
func (c *Cache) cleanupLoop() {
    ticker := time.NewTicker(5 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            c.removeExpired()
        case <-c.stopCleanup:
            return
        }
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
func (c *Cache) removeExpired() {
    c.mu.Lock()
    defer c.mu.Unlock()
    
    expired := make([]string, 0)
    
    for key, item := range c.items {
        if item.IsExpired() {
            expired = append(expired, key)
        }
    }
    
    for _, key := range expired {
        delete(c.items, key)
    }
    
    if len(expired) > 0 {
        fmt.Printf("üóëÔ∏è  –£–¥–∞–ª–µ–Ω–æ %d –∏—Å—Ç–µ–∫—à–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n", len(expired))
    }
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è
func (c *Cache) Set(key string, value interface{}, ttl time.Duration) {
    c.mu.Lock()
    defer c.mu.Unlock()
    
    c.items[key] = &CacheItem{
        Value:     value,
        ExpiresAt: time.Now().Add(ttl),
    }
    
    fmt.Printf("üíæ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫—ç—à: %s\n", key)
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
func (c *Cache) Get(key string) (interface{}, bool) {
    c.mu.RLock()
    defer c.mu.RUnlock()
    
    item, exists := c.items[key]
    if !exists || item.IsExpired() {
        c.misses++
        return nil, false
    }
    
    c.hits++
    return item.Value, true
}

// –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
func (c *Cache) Delete(key string) {
    c.mu.Lock()
    defer c.mu.Unlock()
    
    delete(c.items, key)
    fmt.Printf("üóëÔ∏è  –£–¥–∞–ª–µ–Ω–æ –∏–∑ –∫—ç—à–∞: %s\n", key)
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫—ç—à–∞
func (c *Cache) Size() int {
    c.mu.RLock()
    defer c.mu.RUnlock()
    
    return len(c.items)
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
func (c *Cache) Stats() (hits, misses int64, hitRatio float64) {
    c.mu.RLock()
    defer c.mu.RUnlock()
    
    hits = c.hits
    misses = c.misses
    total := hits + misses
    
    if total > 0 {
        hitRatio = float64(hits) / float64(total) * 100
    }
    
    return
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –∫—ç—à–∞
func (c *Cache) Close() {
    close(c.stopCleanup)
}

// –°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
func fetchFromDatabase(key string) (string, time.Duration) {
    // –°–∏–º—É–ª–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ë–î
    delay := time.Duration(rand.Intn(1000)) * time.Millisecond
    time.Sleep(delay)
    
    return fmt.Sprintf("data_for_%s", key), delay
}

// –°–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à
func dataService(cache *Cache, serviceID int, wg *sync.WaitGroup) {
    defer wg.Done()
    
    keys := []string{"user:123", "user:456", "user:789", "product:1", "product:2"}
    
    for i := 0; i < 10; i++ {
        key := keys[rand.Intn(len(keys))]
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        if value, found := cache.Get(key); found {
            fmt.Printf("üü¢ Service %d: CACHE HIT –¥–ª—è %s = %v\n", serviceID, key, value)
        } else {
            fmt.Printf("üî¥ Service %d: CACHE MISS –¥–ª—è %s\n", serviceID, key)
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–∑ "–±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
            data, dbDelay := fetchFromDatabase(key)
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
            cache.Set(key, data, 10*time.Second)
            
            fmt.Printf("üü° Service %d: –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –ë–î –∑–∞ %v: %s = %s\n", 
                serviceID, dbDelay, key, data)
        }
        
        time.Sleep(500 * time.Millisecond)
    }
}

func main() {
    fmt.Println("üéØ Thread-safe –∫—ç—à —Å TTL")
    fmt.Println()
    
    cache := NewCache()
    defer cache.Close()
    
    var wg sync.WaitGroup
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—ç—à
    for i := 1; i <= 3; i++ {
        wg.Add(1)
        go dataService(cache, i, &wg)
    }
    
    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ
    wg.Add(1)
    go func() {
        defer wg.Done()
        
        ticker := time.NewTicker(3 * time.Second)
        defer ticker.Stop()
        
        for i := 0; i < 5; i++ {
            <-ticker.C
            
            hits, misses, hitRatio := cache.Stats()
            size := cache.Size()
            
            fmt.Printf("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞:\n")
            fmt.Printf("   –†–∞–∑–º–µ—Ä: %d —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n", size)
            fmt.Printf("   –ü–æ–ø–∞–¥–∞–Ω–∏—è: %d\n", hits)
            fmt.Printf("   –ü—Ä–æ–º–∞—Ö–∏: %d\n", misses)
            fmt.Printf("   –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π: %.2f%%\n\n", hitRatio)
        }
    }()
    
    wg.Wait()
    
    // –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    hits, misses, hitRatio := cache.Stats()
    fmt.Printf("üèÅ –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n")
    fmt.Printf("   –ü–æ–ø–∞–¥–∞–Ω–∏—è: %d\n", hits)
    fmt.Printf("   –ü—Ä–æ–º–∞—Ö–∏: %d\n", misses)
    fmt.Printf("   –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π: %.2f%%\n", hitRatio)
}
```

---

## üõ°Ô∏è –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ sync

### 1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π defer —Å Unlock
```go
func (c *Counter) Increment() {
    c.mu.Lock()
    defer c.mu.Unlock() // ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
    c.value++
}
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π RWMutex –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —Å —á–∞—Å—Ç—ã–º —á—Ç–µ–Ω–∏–µ–º
```go
type Cache struct {
    mu   sync.RWMutex // ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
    data map[string]interface{}
}
```

### 3. –ò–∑–±–µ–≥–∞–π –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
```go
// ‚ùå –û–ø–∞—Å–Ω–æ - –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å deadlock
func (c *Cache) BadMethod() {
    c.mu.Lock()
    defer c.mu.Unlock()
    
    c.AnotherMethod() // –ï—Å–ª–∏ AnotherMethod —Ç–æ–∂–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
}
```

### 4. –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–π —Ä–µ—Å—É—Ä—Å—ã
```go
func (c *Cache) Close() {
    close(c.stopCleanup) // ‚úÖ –ó–∞–≤–µ—Ä—à–∞–µ–º –≥–æ—Ä—É—Ç–∏–Ω—É –æ—á–∏—Å—Ç–∫–∏
}
```

---

## üß† –ü—Ä–æ–≤–µ—Ä—å —Å–µ–±—è

- –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Mutex –∏ RWMutex?
- –ó–∞—á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WaitGroup?
- –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å sync.Once?
- –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å deadlock –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –º—å—é—Ç–µ–∫—Å–∞–º–∏?
- –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å defer —Å Unlock()?

---

## üìå –ì–ª–∞–≤–Ω–æ–µ –∏–∑ –≥–ª–∞–≤—ã

- **sync.Mutex** –¥–ª—è –≤–∑–∞–∏–º–Ω–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø–∏—Å–∏
- **sync.RWMutex** –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —á–∏—Ç–∞—Ç–µ–ª–µ–π –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏
- **sync.WaitGroup** –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –≥–æ—Ä—É—Ç–∏–Ω
- **sync.Once** –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- **defer unlock** –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
- **RWMutex –ª—É—á—à–µ Mutex** –∫–æ–≥–¥–∞ —á—Ç–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–∞—â–µ –∑–∞–ø–∏—Å–∏
- **–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π –∫–∞–Ω–∞–ª—ã**, –Ω–æ sync –Ω–µ–∑–∞–º–µ–Ω–∏–º –¥–ª—è –∑–∞—â–∏—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è

---